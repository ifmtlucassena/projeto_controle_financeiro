{% extends "base.html" %}

{% block title %}Dashboard - Controle Financeiro{% endblock %}

{% block content %}
<div class="space-y-8">
    
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900 tracking-tight">Dashboard</h1>
            <p class="text-sm text-gray-500 mt-1">Visão geral das suas finanças em {{ ultima_atualizacao }}</p>
        </div>
        <div>
            <a href="/nova-transacao" class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-gray-900 hover:bg-gray-800 transition-all shadow-sm">
                <i class="bi bi-plus-lg mr-2"></i>
                Nova Transação
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Saldo -->
        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
            <p class="text-sm font-medium text-gray-500 mb-1">Saldo Total</p>
            <h2 class="text-3xl font-bold text-gray-900 tracking-tight">R$ {{ "%.2f"|format(saldo_total) }}</h2>
        </div>

        <!-- Receitas -->
        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 mb-1">Receitas</p>
                <h2 class="text-2xl font-semibold text-emerald-600 tracking-tight">R$ {{ "%.2f"|format(total_receitas) }}</h2>
            </div>
            <div class="w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600">
                <i class="bi bi-arrow-up-short text-2xl"></i>
            </div>
        </div>

        <!-- Despesas -->
        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 mb-1">Despesas</p>
                <h2 class="text-2xl font-semibold text-rose-600 tracking-tight">R$ {{ "%.2f"|format(total_despesas) }}</h2>
            </div>
            <div class="w-10 h-10 bg-rose-50 rounded-full flex items-center justify-center text-rose-600">
                <i class="bi bi-arrow-down-short text-2xl"></i>
            </div>
        </div>
    </div>

    <!-- Filters (Collapsible or Simple Row) -->
    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
        <form method="GET" action="/" class="flex flex-col md:flex-row gap-4 items-end md:items-end">
            <div class="w-full md:w-auto">
                <label for="data_inicio" class="block text-xs font-medium text-gray-500 mb-1">Início</label>
                <input type="date" name="data_inicio" value="{{ data_inicio }}" class="block w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-gray-900 focus:ring-1 focus:ring-gray-900">
            </div>
            <div class="w-full md:w-auto">
                <label for="data_fim" class="block text-xs font-medium text-gray-500 mb-1">Fim</label>
                <input type="date" name="data_fim" value="{{ data_fim }}" class="block w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-gray-900 focus:ring-1 focus:ring-gray-900">
            </div>
            <div class="w-full md:w-auto flex-grow max-w-xs">
                <label for="categoria" class="block text-xs font-medium text-gray-500 mb-1">Categoria</label>
                <select name="categoria" class="block w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-gray-900 focus:ring-1 focus:ring-gray-900">
                    <option value="todas">Todas</option>
                    <option value="Trabalho" {% if categoria_selecionada == 'Trabalho' %}selected{% endif %}>Trabalho</option>
                    <option value="Alimentação" {% if categoria_selecionada == 'Alimentação' %}selected{% endif %}>Alimentação</option>
                    <option value="Transporte" {% if categoria_selecionada == 'Transporte' %}selected{% endif %}>Transporte</option>
                    <option value="Moradia" {% if categoria_selecionada == 'Moradia' %}selected{% endif %}>Moradia</option>
                    <option value="Saúde" {% if categoria_selecionada == 'Saúde' %}selected{% endif %}>Saúde</option>
                    <option value="Educação" {% if categoria_selecionada == 'Educação' %}selected{% endif %}>Educação</option>
                    <option value="Lazer" {% if categoria_selecionada == 'Lazer' %}selected{% endif %}>Lazer</option>
                </select>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <button type="submit" class="px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-colors">Filtrar</button>
                <a href="/" class="px-4 py-2 bg-white border border-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors">Limpar</a>
            </div>
        </form>
    </div>

    <!-- Charts Section -->
    {% if dados_grafico and (total_receitas > 0 or total_despesas > 0) %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Fluxo -->
        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
            <h3 class="text-base font-semibold text-gray-900 mb-6">Fluxo de Caixa</h3>
            <div class="h-64 relative">
                <canvas id="chartReceitasDespesas"></canvas>
            </div>
        </div>
        <!-- Categorias -->
        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
            <h3 class="text-base font-semibold text-gray-900 mb-6">Despesas por Categoria</h3>
            <div class="h-64 relative">
                <canvas id="chartDespesasCategorias"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Transactions List -->
    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-base font-semibold text-gray-900">Transações Recentes</h3>
            <a href="/api/transacoes" class="text-sm font-medium text-gray-500 hover:text-gray-900">Ver API</a>
        </div>
        
        {% if transacoes_recentes %}
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500">
                    <tr>
                        <th class="px-6 py-3 font-medium">Descrição</th>
                        <th class="px-6 py-3 font-medium">Categoria</th>
                        <th class="px-6 py-3 font-medium">Data</th>
                        <th class="px-6 py-3 font-medium text-right">Valor</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for transacao in transacoes_recentes %}
                    <tr class="hover:bg-gray-50 transition-colors group">
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center 
                                    {% if transacao.tipo == 'receita' %}bg-emerald-50 text-emerald-600{% else %}bg-rose-50 text-rose-600{% endif %}">
                                    <i class="bi bi-{% if transacao.tipo == 'receita' %}arrow-up{% else %}arrow-down{% endif %} text-sm"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">{{ transacao.descricao }}</p>
                                    <p class="text-xs text-gray-500">
                                        {% if transacao.tipo == 'despesa' %}{{ transacao.estabelecimento }}{% else %}{{ transacao.conta_destino }}{% endif %}
                                    </p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                {{ transacao.categoria }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-gray-500">
                            {{ transacao.data }}
                        </td>
                        <td class="px-6 py-4 text-right font-medium {% if transacao.tipo == 'receita' %}text-emerald-600{% else %}text-rose-600{% endif %}">
                            {% if transacao.tipo == 'receita' %}+{% else %}-{% endif %} R$ {{ "%.2f"|format(transacao.valor) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="p-12 text-center text-gray-500">
            <i class="bi bi-inbox text-4xl mb-3 block text-gray-300"></i>
            <p>Nenhuma transação encontrada.</p>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Global Defaults
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6B7280';
    Chart.defaults.scale.grid.color = '#F3F4F6';
    
    {% if dados_grafico and (total_receitas > 0 or total_despesas > 0) %}

    // Doughnut Chart
    const ctxDoughnut = document.getElementById('chartReceitasDespesas');
    if (ctxDoughnut) {
        new Chart(ctxDoughnut, {
            type: 'doughnut',
            data: {
                labels: {{ dados_grafico.receitas_vs_despesas.labels | tojson }},
                datasets: [{
                    data: {{ dados_grafico.receitas_vs_despesas.data | tojson }},
                    backgroundColor: ['#10B981', '#F43F5E'], // Emerald-500, Rose-500
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 20 }
                    },
                    tooltip: {
                        backgroundColor: '#1F2937',
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return ' R$ ' + context.parsed.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    // Bar Chart
    const ctxBar = document.getElementById('chartDespesasCategorias');
    if (ctxBar) {
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: {{ dados_grafico.despesas_por_categoria.labels | tojson }},
                datasets: [{
                    label: 'Valor',
                    data: {{ dados_grafico.despesas_por_categoria.data | tojson }},
                    backgroundColor: '#F43F5E',
                    borderRadius: 4,
                    barThickness: 24
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { display: true, drawBorder: false },
                        ticks: { callback: (val) => 'R$ ' + val }
                    },
                    x: {
                        grid: { display: false, drawBorder: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1F2937',
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return 'R$ ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}
