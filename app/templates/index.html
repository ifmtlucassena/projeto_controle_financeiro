{% extends "base.html" %}

{% block title %}Dashboard - Controle Financeiro{% endblock %}

{% block content %}
<!-- Cabeçalho -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
    <div>
        <h1 class="text-3xl font-bold text-slate-900 mb-2">
            Dashboard Financeiro
        </h1>
        <p class="text-sm text-slate-500 flex items-center">
            <i class="bi bi-clock mr-2"></i>
            {{ ultima_atualizacao }}
        </p>
    </div>
    <div class="mt-4 md:mt-0">
        <a href="/nova-transacao" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white text-sm font-semibold rounded-xl shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/50 hover:from-emerald-600 hover:to-emerald-700 transition-all duration-300">
            <i class="bi bi-plus-circle mr-2"></i>
            Nova Transação
        </a>
    </div>
</div>

<!-- Seção de Filtros -->
<div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8">
    <form method="GET" action="/">
        <div class="flex items-center mb-4">
            <i class="bi bi-funnel text-slate-600 mr-2"></i>
            <h2 class="text-lg font-semibold text-slate-900">Filtros de Relatório</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <!-- Data Início -->
            <div>
                <label for="data_inicio" class="block text-sm font-medium text-slate-700 mb-2">
                    Data Início
                </label>
                <input type="date"
                       id="data_inicio"
                       name="data_inicio"
                       value="{{ data_inicio }}"
                       class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-200">
            </div>

            <!-- Data Fim -->
            <div>
                <label for="data_fim" class="block text-sm font-medium text-slate-700 mb-2">
                    Data Fim
                </label>
                <input type="date"
                       id="data_fim"
                       name="data_fim"
                       value="{{ data_fim }}"
                       class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-200">
            </div>

            <!-- Categoria -->
            <div>
                <label for="categoria" class="block text-sm font-medium text-slate-700 mb-2">
                    Categoria
                </label>
                <select id="categoria"
                        name="categoria"
                        class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-200">
                    <option value="todas" {% if categoria_selecionada == 'todas' %}selected{% endif %}>Todas as Categorias</option>
                    <option value="Trabalho" {% if categoria_selecionada == 'Trabalho' %}selected{% endif %}>Trabalho</option>
                    <option value="Alimentação" {% if categoria_selecionada == 'Alimentação' %}selected{% endif %}>Alimentação</option>
                    <option value="Transporte" {% if categoria_selecionada == 'Transporte' %}selected{% endif %}>Transporte</option>
                    <option value="Moradia" {% if categoria_selecionada == 'Moradia' %}selected{% endif %}>Moradia</option>
                    <option value="Saúde" {% if categoria_selecionada == 'Saúde' %}selected{% endif %}>Saúde</option>
                    <option value="Educação" {% if categoria_selecionada == 'Educação' %}selected{% endif %}>Educação</option>
                    <option value="Lazer" {% if categoria_selecionada == 'Lazer' %}selected{% endif %}>Lazer</option>
                </select>
            </div>
        </div>

        <div class="flex flex-wrap items-center gap-3">
            <button type="submit" class="inline-flex items-center px-5 py-2.5 bg-emerald-600 text-white text-sm font-medium rounded-xl hover:bg-emerald-700 shadow-sm hover:shadow-md transition-all duration-200">
                <i class="bi bi-search mr-2"></i>
                Aplicar Filtros
            </button>
            <a href="/" class="inline-flex items-center px-5 py-2.5 bg-slate-100 text-slate-700 text-sm font-medium rounded-xl hover:bg-slate-200 transition-all duration-200">
                <i class="bi bi-x-circle mr-2"></i>
                Limpar
            </a>

            {% if filtros_ativos %}
                <div class="flex items-center gap-2 text-sm text-slate-600 ml-auto">
                    <i class="bi bi-check-circle"></i>
                    <span>Filtros ativos:</span>
                    {% if filtros_ativos.data_inicio %}
                        <span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-lg font-medium">
                            De: {{ filtros_ativos.data_inicio }}
                        </span>
                    {% endif %}
                    {% if filtros_ativos.data_fim %}
                        <span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-lg font-medium">
                            Até: {{ filtros_ativos.data_fim }}
                        </span>
                    {% endif %}
                    {% if filtros_ativos.categoria %}
                        <span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-lg font-medium">
                            {{ filtros_ativos.categoria }}
                        </span>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </form>
</div>

<!-- Cards de Resumo -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Saldo Total -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hover:shadow-md transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-slate-100 to-slate-200 rounded-xl flex items-center justify-center">
                <i class="bi bi-wallet2 text-slate-600 text-xl"></i>
            </div>
            <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">
                Saldo Atual
            </span>
        </div>
        <div class="{% if saldo_total >= 0 %}text-emerald-600{% else %}text-rose-600{% endif %} text-3xl font-bold mb-1">
            R$ {{ "%.2f"|format(saldo_total) }}
        </div>
        <p class="text-sm text-slate-500">
            {{ quantidade_receitas + quantidade_despesas }} transações
        </p>
    </div>

    <!-- Total Receitas -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hover:shadow-md transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl flex items-center justify-center">
                <i class="bi bi-arrow-up-circle text-emerald-600 text-xl"></i>
            </div>
            <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">
                Receitas
            </span>
        </div>
        <div class="text-emerald-600 text-3xl font-bold mb-1">
            R$ {{ "%.2f"|format(total_receitas) }}
        </div>
        <p class="text-sm text-slate-500">
            {{ quantidade_receitas }} {% if quantidade_receitas == 1 %}entrada{% else %}entradas{% endif %}
        </p>
    </div>

    <!-- Total Despesas -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 hover:shadow-md transition-all duration-300">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-rose-50 to-rose-100 rounded-xl flex items-center justify-center">
                <i class="bi bi-arrow-down-circle text-rose-600 text-xl"></i>
            </div>
            <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">
                Despesas
            </span>
        </div>
        <div class="text-rose-600 text-3xl font-bold mb-1">
            R$ {{ "%.2f"|format(total_despesas) }}
        </div>
        <p class="text-sm text-slate-500">
            {{ quantidade_despesas }} {% if quantidade_despesas == 1 %}saída{% else %}saídas{% endif %}
        </p>
    </div>
</div>

<!-- Gráficos -->
{% if dados_grafico and (total_receitas > 0 or total_despesas > 0) %}
<div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
    <!-- Gráfico: Receitas vs Despesas -->
    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center">
            <i class="bi bi-pie-chart mr-2 text-emerald-600"></i>
            Receitas vs Despesas
        </h3>
        <div class="relative h-64">
            <canvas id="chartReceitasDespesas"></canvas>
        </div>
    </div>

    <!-- Gráfico: Despesas por Categoria -->
    <div class="lg:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center">
            <i class="bi bi-bar-chart mr-2 text-rose-600"></i>
            Despesas por Categoria
        </h3>
        <div class="relative h-64">
            <canvas id="chartDespesasCategorias"></canvas>
        </div>
    </div>
</div>
{% endif %}

<!-- Resumo e Transações -->
<div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
    <!-- Resumo por Categoria -->
    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center">
            <i class="bi bi-list-check mr-2 text-slate-600"></i>
            Resumo Detalhado
        </h3>

        {% if resumo_por_categoria.despesas %}
            <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-3 flex items-center">
                <i class="bi bi-arrow-down-circle text-rose-600 mr-2"></i>
                Despesas por Categoria
            </h4>
            <div class="space-y-3 mb-6">
                {% for item in resumo_por_categoria.despesas[:5] %}
                    <div>
                        <div class="flex justify-between items-center mb-1.5">
                            <span class="text-sm font-medium text-slate-700">{{ item.categoria }}</span>
                            <span class="text-sm font-bold text-slate-900">R$ {{ "%.2f"|format(item.valor) }}</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2">
                            <div class="bg-gradient-to-r from-rose-400 to-rose-600 h-2 rounded-full transition-all duration-500"
                                 style="width: {{ item.percentual }}%">
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">{{ "%.1f"|format(item.percentual) }}%</p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% if resumo_por_categoria.receitas %}
            <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-3 flex items-center">
                <i class="bi bi-arrow-up-circle text-emerald-600 mr-2"></i>
                Receitas por Categoria
            </h4>
            <div class="space-y-2">
                {% for item in resumo_por_categoria.receitas[:5] %}
                    <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition-colors duration-200">
                        <span class="text-sm font-medium text-slate-700">{{ item.categoria }}</span>
                        <span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-sm font-bold rounded-lg">
                            R$ {{ "%.2f"|format(item.valor) }}
                        </span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% if not resumo_por_categoria.despesas and not resumo_por_categoria.receitas %}
            <div class="text-center py-12">
                <i class="bi bi-inbox text-6xl text-slate-300"></i>
                <p class="mt-4 text-slate-500">Nenhuma transação registrada ainda.</p>
                <a href="/nova-transacao" class="inline-flex items-center mt-4 px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-xl hover:bg-emerald-700 transition-colors duration-200">
                    <i class="bi bi-plus-circle mr-2"></i>
                    Adicionar Primeira Transação
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Transações Recentes -->
    <div class="lg:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="p-6 border-b border-slate-200">
            <h3 class="text-lg font-semibold text-slate-900 flex items-center">
                <i class="bi bi-clock-history mr-2 text-slate-600"></i>
                Transações Recentes
            </h3>
        </div>

        {% if transacoes_recentes %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Descrição</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Categoria</th>
                            <th class="px-6 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Valor</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for transacao in transacoes_recentes %}
                        <tr class="hover:bg-slate-50 transition-colors duration-150">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm text-slate-600">{{ transacao.data }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-semibold {% if transacao.tipo == 'receita' %}bg-emerald-100 text-emerald-700{% else %}bg-rose-100 text-rose-700{% endif %}">
                                    <i class="bi bi-arrow-{% if transacao.tipo == 'receita' %}up{% else %}down{% endif %} mr-1"></i>
                                    {% if transacao.tipo == 'receita' %}Receita{% else %}Despesa{% endif %}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-slate-900">{{ transacao.descricao }}</div>
                                <div class="text-xs text-slate-500">
                                    <i class="bi bi-{% if transacao.tipo == 'despesa' %}shop{% else %}bank{% endif %} mr-1"></i>
                                    {% if transacao.tipo == 'despesa' %}{{ transacao.estabelecimento }}{% else %}{{ transacao.conta_destino }}{% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2.5 py-1 bg-slate-100 text-slate-700 text-xs font-medium rounded-lg">
                                    {{ transacao.categoria }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <span class="text-sm font-bold {% if transacao.tipo == 'receita' %}text-emerald-600{% else %}text-rose-600{% endif %}">
                                    {% if transacao.tipo == 'receita' %}+{% else %}-{% endif %} R$ {{ "%.2f"|format(transacao.valor) }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-12">
                <i class="bi bi-inbox text-6xl text-slate-300"></i>
                <p class="mt-4 text-slate-500">Nenhuma transação registrada.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Estatísticas Adicionais -->
{% if estatisticas and estatisticas.total_transacoes > 0 %}
<div class="mt-8 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
    <h3 class="text-lg font-semibold text-slate-900 mb-6 flex items-center">
        <i class="bi bi-graph-up mr-2 text-slate-600"></i>
        Estatísticas
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="text-center">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Total de Transações</p>
            <p class="text-2xl font-bold text-slate-900">{{ estatisticas.total_transacoes }}</p>
        </div>
        <div class="text-center">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Valor Médio</p>
            <p class="text-2xl font-bold text-slate-900">R$ {{ "%.2f"|format(estatisticas.valor_medio) }}</p>
        </div>
        <div class="text-center">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Maior Transação</p>
            <p class="text-2xl font-bold text-emerald-600">R$ {{ "%.2f"|format(estatisticas.maior_transacao) }}</p>
        </div>
        <div class="text-center">
            <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Menor Transação</p>
            <p class="text-2xl font-bold text-slate-900">R$ {{ "%.2f"|format(estatisticas.menor_transacao) }}</p>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Inicialização dos gráficos com Chart.js
document.addEventListener('DOMContentLoaded', function() {
    {% if dados_grafico and (total_receitas > 0 or total_despesas > 0) %}

    // Gráfico 1: Receitas vs Despesas (Doughnut)
    const ctxDoughnut = document.getElementById('chartReceitasDespesas');
    if (ctxDoughnut) {
        new Chart(ctxDoughnut, {
            type: 'doughnut',
            data: {
                labels: {{ dados_grafico.receitas_vs_despesas.labels | tojson }},
                datasets: [{
                    data: {{ dados_grafico.receitas_vs_despesas.data | tojson }},
                    backgroundColor: ['#059669', '#e11d48'],
                    borderWidth: 0,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 13,
                                family: "'Inter', sans-serif"
                            },
                            color: '#475569'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        titleColor: '#f1f5f9',
                        bodyColor: '#f1f5f9',
                        borderColor: '#334155',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                return label + ': R$ ' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    // Gráfico 2: Despesas por Categoria (Bar)
    const ctxBar = document.getElementById('chartDespesasCategorias');
    if (ctxBar && {{ dados_grafico.despesas_por_categoria.labels | length }} > 0) {
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: {{ dados_grafico.despesas_por_categoria.labels | tojson }},
                datasets: [{
                    label: 'Valor (R$)',
                    data: {{ dados_grafico.despesas_por_categoria.data | tojson }},
                    backgroundColor: 'rgba(225, 29, 72, 0.8)',
                    borderColor: '#e11d48',
                    borderWidth: 0,
                    borderRadius: 8,
                    barThickness: 'flex'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#f1f5f9',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#64748b',
                            font: {
                                family: "'Inter', sans-serif"
                            },
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#64748b',
                            font: {
                                family: "'Inter', sans-serif"
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1e293b',
                        titleColor: '#f1f5f9',
                        bodyColor: '#f1f5f9',
                        borderColor: '#334155',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return 'R$ ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    {% endif %}
});
</script>
{% endblock %}
